<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
              "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
              
<mapper namespace="kr.co.gotthem.mybatis.orderMapper">


    <!-- 1. 단건 결제 추가 -->
    <insert id="insertOrder">
        INSERT INTO order (
           ord_memno, ord_procode, ord_proname, ord_prostock, ord_price
      )VALUES(
       #{bas_memno}, #{bas_procode}, #{bas_proname},#{bas_prostock}, #{money})
    </insert> 
   <!-- 1.1. 상품 삭제 -->
    <delete id="deleteOrder">
        DELETE FROM product
        WHERE pro_no = #{bas_no}
    </delete>


    <!-- 2. 장바구니 목록 -->
    <select id="listOrder" resultType="kr.co.gotthem.order.bean.OrderBean">
         SELECT
            b.bas_no AS bas_no, 
            b.bas_memno AS bas_memno,
            b.bas_procode,
            b.bas_proname,
            b.bas_stono,          
            b.bas_procategory,
            b.bas_proexdate,
            p.pro_code As pro_code,
            b.bas_proprice,
            m.mem_no AS mem_no, 
            p.pro_name AS pro_name, 
            b.bas_prostock,        
            p.pro_price,
            (pro_price * bas_prostock) money
        FROM
            member m, product p, basket b
        WHERE m.mem_no = b.bas_memno
            AND p.pro_code = b.bas_procode
            AND b.bas_memno = #{bas_memno}
        ORDER BY
            b.bas_no
    </select>
    
    <!-- 3. 장바구니 전체 금액 -->
    <select id="sumMoney" resultType="int">
        SELECT IFNULL(SUM(pro_price * bas_prostock), 0)
        FROM basket b,product p
        WHERE b.bas_procode = p.pro_code AND b.bas_memno = #{mem_no}
    </select>
     
    <!-- 4. 장바구니 수정(수량만 수정) -->
    <update id="modifyBasket">
        UPDATE basket   
        SET bas_prostock = #{bas_prostock} 
        WHERE bas_memno= #{bas_memno} AND bas_procode = #{bas_procode}
    </update>  
 
    <!-- 5. 장바구니 삭제 -->
    <delete id="deleteOrder">
        DELETE FROM basket
        WHERE bas_no = #{bas_no}
    </delete>

	<!-- 6. 장바구니에 동일한 상품 레코드 확인 -->
    <select id="countOrder" resultType="int">
        select count(*) from basket
        WHERE bas_memno= #{bas_memno} AND bas_procode = #{bas_procode}
    </select>
    
    <!-- 7. 장바구니에 동일한 상품이 존재하면 수정(insert시,동일한 상품 존재시 기존 수량에 새로운 수량 더하기 -->
    <update id="updateOrder">
        UPDATE basket 
        SET bas_prostock = bas_prostock + #{bas_prostock} 
        WHERE bas_memno= #{bas_memno} AND bas_procode = #{bas_procode}
    </update>
	
</mapper>
